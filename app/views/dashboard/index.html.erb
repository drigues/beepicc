# config/routes.rb
Rails.application.routes.draw do
  root "dashboard#index"
  devise_for :users

  resource :dashboard, only: [:show], controller: 'dashboard'
  resource :profile, only: [:edit, :update]
  resources :links do
    member do
      post :track_click
    end
  end
end

# app/controllers/dashboard_controller.rb
class DashboardController < ApplicationController
  before_action :authenticate_user!

  def index
    @profile = current_user.profile
    @links = current_user.links.order(:position)
  end
end

# app/controllers/profiles_controller.rb
class ProfilesController < ApplicationController
  before_action :authenticate_user!

  def edit
    @profile = current_user.profile || current_user.build_profile
  end

  def update
    @profile = current_user.profile
    if @profile.update(profile_params)
      redirect_to dashboard_path, notice: 'Profile updated.'
    else
      render :edit
    end
  end

  private

  def profile_params
    params.require(:profile).permit(:name, :bio, :avatar_url, :color_theme, social_links: [])
  end
end

# app/controllers/links_controller.rb
class LinksController < ApplicationController
  before_action :authenticate_user!
  before_action :set_link, only: [:edit, :update, :destroy, :track_click]

  def create
    @link = current_user.links.new(link_params)
    if @link.save
      redirect_to dashboard_path, notice: 'Link added.'
    else
      redirect_to dashboard_path, alert: 'Failed to add link.'
    end
  end

  def update
    if @link.update(link_params)
      redirect_to dashboard_path, notice: 'Link updated.'
    else
      redirect_to dashboard_path, alert: 'Update failed.'
    end
  end

  def destroy
    @link.destroy
    redirect_to dashboard_path, notice: 'Link deleted.'
  end

  def track_click
    @link.increment!(:click_count)
    redirect_to @link.url
  end

  private

  def set_link
    @link = current_user.links.find(params[:id])
  end

  def link_params
    params.require(:link).permit(:title, :url, :link_type, :position)
  end
end

# app/views/dashboard/index.html.erb
<%= render 'shared/sidebar' %>
<div class="dashboard-main">
  <h2>Hello, <%= current_user.profile&.name || current_user.email %> ðŸ‘‹</h2>
  <%= render 'dashboard/stats', profile: @profile %>
  <%= render 'dashboard/link_preview', links: @links %>
</div>

# app/views/shared/_sidebar.html.erb
<nav class="sidebar">
  <%= link_to 'Profile', edit_profile_path %>
  <%= link_to 'Links', dashboard_path %>
  <%= link_to 'Themes', edit_profile_path(anchor: 'themes') %>
  <%= link_to 'Analytics', dashboard_path(anchor: 'analytics') %>
  <%= link_to 'Settings', edit_user_registration_path %>
</nav>

# app/views/dashboard/_stats.html.erb
<div class="stats">
  <div>Total Clicks: <%= profile.links.sum(:click_count) %></div>
</div>

# app/views/dashboard/_link_preview.html.erb
<div class="links-preview">
  <% links.each do |link| %>
    <div class="link-item">
      <strong><%= link.title %></strong> - <%= link.url %> - <%= link.click_count %> clicks
      <%= link_to 'Edit', edit_link_path(link), class: 'btn' %>
      <%= link_to 'Delete', link_path(link), method: :delete, data: { confirm: 'Sure?' }, class: 'btn-danger' %>
    </div>
  <% end %>
</div>

# app/views/profiles/edit.html.erb
<h2>Edit Profile</h2>
<%= form_with model: @profile, url: profile_path, method: :patch do |f| %>
  <%= f.label :name %>
  <%= f.text_field :name %>

  <%= f.label :bio %>
  <%= f.text_area :bio %>

  <%= f.label :avatar_url %>
  <%= f.text_field :avatar_url %>

  <%= f.label :color_theme %>
  <%= f.select :color_theme, options_for_select(["purple", "cyan", "pink"], @profile.color_theme) %>

  <%= f.submit 'Save' %>
<% end %>
